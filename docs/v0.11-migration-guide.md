# Migration Guide: v0.11.0 Breaking Changes

**vcli v0.11.0 introduces breaking changes to the `init` and `profile` commands to improve GitOps and CI/CD compatibility.**

## Breaking Changes Summary

| Change | Old Behavior | New Behavior | Impact |
|--------|--------------|--------------|--------|
| **Init Command** | Interactive prompts | Non-interactive by default | Scripts using `vcli init` will now complete without user input |
| **Profile Commands** | Interactive prompts | Direct arguments | `vcli profile` commands require explicit arguments |
| **JSON Output** | Not available | JSON to stdout by default | Output format changed for piping/automation |

## Migration Timeline

- **v0.11.0-beta1** (Current): Breaking changes introduced, legacy mode available
- **v0.11.0** (Stable): Breaking changes finalized, deprecation warnings added
- **v0.12.0** (Future): Legacy interactive mode removed entirely

## Why These Changes?

### Problems with Old Behavior

1. **Interactive prompts break CI/CD pipelines**
   ```bash
   # This would hang in CI/CD waiting for user input
   vcli init
   ```

2. **Profile commands not scriptable**
   ```bash
   # Old: Required interactive selection
   vcli profile --list
   > Select profile: _
   ```

3. **No structured output for automation**
   ```bash
   # Old: Human-readable text only
   vcli profile --get
   > Profile set to: vbr
   ```

### New Design Goals

- ✅ Non-interactive by default (CI/CD friendly)
- ✅ Structured JSON output for piping
- ✅ Explicit command syntax (no hidden prompts)
- ✅ Legacy mode available during transition

## Migrating: Init Command

### Old Syntax (v0.10.x and earlier)

```bash
# Interactive prompts
./vcli init

# Output:
> Allow insecure TLS? (y/N): n
> Use Creds file mode? (y/N): n
> Initialized, ensure all environment variables are set.
```

### New Syntax (v0.11.0+)

#### Option 1: Non-Interactive (Recommended)

```bash
# Non-interactive with flags
./vcli init --output-dir .vcli/ --insecure --creds-file

# Output: JSON to stdout
{
  "settings": {
    "selectedProfile": "vbr",
    "apiNotSecure": true,
    "credsFileMode": true
  },
  "profiles": [...],
  "files": {
    "settings": ".vcli/settings.json",
    "profiles": ".vcli/profiles.json"
  }
}
```

#### Option 2: Interactive (Legacy Mode)

```bash
# Explicit interactive mode
./vcli init --interactive

# Behaves like v0.10.x
```

### Migration Examples

**Scenario 1: Simple init (defaults)**

```bash
# Old (v0.10.x) - hangs in CI/CD
./vcli init
> (waits for user input)

# New (v0.11.0+) - completes immediately
./vcli init
# Creates files with defaults, outputs JSON
```

**Scenario 2: Init with custom settings**

```bash
# Old (v0.10.x) - required manual prompts
./vcli init
> Allow insecure TLS? (y/N): y
> Use Creds file mode? (y/N): y

# New (v0.11.0+) - explicit flags
./vcli init --insecure --creds-file
```

**Scenario 3: CI/CD pipeline init**

```bash
# Old (v0.10.x) - didn't work
./vcli init  # Would hang waiting for input

# New (v0.11.0+) - works perfectly
./vcli init --output-dir $BUILD_DIR/.vcli/
```

### New Init Features

#### Subcommands

Initialize settings and profiles separately:

```bash
# Initialize only settings
./vcli init settings --insecure --creds-file

# Initialize only profiles
./vcli init profiles

# Initialize both (default)
./vcli init
```

#### JSON Piping

Process init output programmatically:

```bash
# Extract settings only
./vcli init | jq '.settings' > .vcli/settings.json

# Extract profiles only
./vcli init | jq '.profiles' > .vcli/profiles.json

# Check if files were created
./vcli init | jq -r '.files.settings'
# Output: .vcli/settings.json
```

#### Output Directory Control

```bash
# Write to specific directory
./vcli init --output-dir /opt/vcli/config/

# Write to build directory (CI/CD)
./vcli init --output-dir $CI_PROJECT_DIR/.vcli/

# Write to current directory (default)
./vcli init
```

### Updated Flags

| Flag | Description | Default |
|------|-------------|---------|
| `--interactive` | Run in legacy interactive mode | false |
| `--insecure` | Skip TLS verification (sets `apiNotSecure: true`) | false |
| `--creds-file` | Enable credentials file mode | false |
| `--output-dir <path>` | Directory to write config files | Current directory or `VCLI_SETTINGS_PATH` |

## Migrating: Profile Commands

### Old Syntax (v0.10.x and earlier)

```bash
# Interactive profile selection
./vcli profile --set
> Select profile: vbr

# Get current profile
./vcli profile --get
> Profile set to: vbr
```

### New Syntax (v0.11.0+)

```bash
# Direct argument (no prompt)
./vcli profile --set vbr

# Get current profile (clean output)
./vcli profile --get
vbr
```

### Profile Command Changes

**Setting Profile:**

```bash
# Old - prompted for selection
./vcli profile --set

# New - requires explicit argument
./vcli profile --set vbr
./vcli profile -s vbr
```

**Getting Profile:**

```bash
# Old - verbose output
./vcli profile --get
> Profile set to: vbr

# New - clean output (scriptable)
./vcli profile --get
vbr
```

**Listing Profiles:**

```bash
# Old and New - unchanged
./vcli profile --list
```

### Migration Examples for Scripts

**Script Example 1: Set profile and login**

```bash
# Old (v0.10.x) - didn't work in scripts
./vcli profile --set  # Would wait for input
./vcli login

# New (v0.11.0+) - works in scripts
./vcli profile --set vbr
./vcli login
```

**Script Example 2: Verify current profile**

```bash
# Old (v0.10.x) - needed text parsing
CURRENT=$(./vcli profile --get | cut -d':' -f2 | xargs)

# New (v0.11.0+) - clean output
CURRENT=$(./vcli profile --get)
if [ "$CURRENT" != "vbr" ]; then
    ./vcli profile --set vbr
fi
```

## CI/CD Pipeline Migration

### Old Pipeline (v0.10.x) - Didn't Work

```yaml
# Azure DevOps - This would hang
steps:
  - script: |
      ./vcli init  # HANGS - waits for input
      ./vcli profile --set  # HANGS - waits for input
      ./vcli login
      ./vcli get jobs
```

### New Pipeline (v0.11.0+) - Works Perfectly

```yaml
# Azure DevOps - Non-interactive
steps:
  - script: |
      # Initialize non-interactively
      ./vcli init --output-dir .vcli/ --insecure

      # Set profile directly
      ./vcli profile --set vbr

      # Login and use
      ./vcli login
      ./vcli get jobs
    env:
      VCLI_USERNAME: $(VCLI_USERNAME)
      VCLI_PASSWORD: $(VCLI_PASSWORD)
      VCLI_URL: $(VCLI_URL)
      VCLI_SETTINGS_PATH: $(Build.SourcesDirectory)/.vcli/
```

### GitHub Actions Migration

```yaml
# Old (v0.10.x) - Didn't work
- name: Setup vcli
  run: |
    ./vcli init  # Would hang

# New (v0.11.0+) - Works perfectly
- name: Setup vcli
  run: |
    ./vcli init --output-dir .vcli/
    ./vcli profile --set vbr
  env:
    VCLI_SETTINGS_PATH: ${{ github.workspace }}/.vcli/
```

## Backwards Compatibility (Temporary)

### Using Legacy Interactive Mode

If you need the old behavior temporarily:

```bash
# Run in legacy interactive mode
./vcli init --interactive

# Old-style prompts appear
> Allow insecure TLS? (y/N):
```

**Deprecation Warning:**

When using `--interactive`, you'll see:

```
⚠️  WARNING: Interactive mode is deprecated and will be removed in v0.12.0
   Use 'vcli init --interactive' to explicitly enable interactive mode
   Or use non-interactive mode: 'vcli init --insecure --creds-file'
```

### Timeline for Removal

- **v0.11.0**: `--interactive` flag available, deprecation warning shown
- **v0.12.0**: `--interactive` flag removed, non-interactive becomes only option

### Migration Checklist

Before upgrading to v0.11.0:

- [ ] Audit all scripts and pipelines using `vcli init`
- [ ] Add explicit flags (`--insecure`, `--creds-file`, `--output-dir`)
- [ ] Update profile commands to use direct arguments
- [ ] Test in CI/CD environment before production deployment
- [ ] Update documentation and runbooks
- [ ] Train team on new command syntax

## Common Migration Patterns

### Pattern 1: Simple Setup Script

```bash
#!/bin/bash
# Old (v0.10.x)
./vcli init
# (Would require manual input)

# New (v0.11.0+)
./vcli init --output-dir ~/.vcli/
./vcli profile --set vbr
echo "Setup complete"
```

### Pattern 2: Multi-Environment Setup

```bash
#!/bin/bash
# New (v0.11.0+)
ENV=${1:-dev}

case $ENV in
  prod)
    ./vcli init --output-dir ~/.vcli/prod/
    ./vcli profile --set vbr
    ;;
  dev)
    ./vcli init --output-dir ~/.vcli/dev/ --insecure
    ./vcli profile --set vbr
    ;;
esac
```

### Pattern 3: Docker Container Init

```dockerfile
# Dockerfile
FROM alpine:latest
RUN apk add --no-cache bash

COPY vcli /usr/local/bin/
COPY entrypoint.sh /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
```

```bash
#!/bin/bash
# entrypoint.sh - New (v0.11.0+)
set -e

# Non-interactive init
./vcli init --output-dir /vcli/ --insecure

# Set profile from env var
./vcli profile --set ${VCLI_PROFILE:-vbr}

# Execute command
exec "$@"
```

## Testing Your Migration

### Step 1: Test Locally

```bash
# Test non-interactive init
./vcli init --output-dir /tmp/vcli-test/

# Verify files created
ls -la /tmp/vcli-test/
# Should show: settings.json, profiles.json

# Test profile setting
VCLI_SETTINGS_PATH=/tmp/vcli-test/ ./vcli profile --set vbr

# Verify profile
VCLI_SETTINGS_PATH=/tmp/vcli-test/ ./vcli profile --get
# Should output: vbr

# Cleanup
rm -rf /tmp/vcli-test/
```

### Step 2: Test in CI/CD

```yaml
# Add test job to pipeline
- job: Test_New_Init
  steps:
    - script: |
        ./vcli init --output-dir .vcli/
        TEST_PROFILE=$(VCLI_SETTINGS_PATH=.vcli/ ./vcli profile --set vbr && VCLI_SETTINGS_PATH=.vcli/ ./vcli profile --get)
        if [ "$TEST_PROFILE" != "vbr" ]; then
          echo "Migration test failed"
          exit 1
        fi
        echo "Migration test passed"
```

## Rollback Plan

If you encounter issues with v0.11.0:

### Option 1: Use Legacy Mode

```bash
# Continue using old behavior temporarily
./vcli init --interactive
```

### Option 2: Downgrade to v0.10.x

```bash
# Download v0.10.x binary
curl -L https://github.com/shapedthought/vcli/releases/download/v0.10.0/vcli-linux-amd64 -o vcli

# Use old version
./vcli init
```

### Option 3: Pin Version in CI/CD

```yaml
# Azure DevOps
- task: DownloadGitHubRelease@0
  inputs:
    version: 'v0.10.0'  # Pin to working version
```

## Getting Help

If you encounter migration issues:

1. **Check this guide** for your specific scenario
2. **Review examples** in `/examples/` directory
3. **Open an issue** on GitHub with:
   - Current command that's failing
   - Expected behavior
   - Error messages or unexpected output
4. **Join discussions** for community support

## Summary

**Key Takeaways:**

1. ✅ `vcli init` is now non-interactive by default
2. ✅ Use `--interactive` flag for legacy behavior (temporary)
3. ✅ Profile commands require explicit arguments
4. ✅ JSON output enables automation and piping
5. ✅ CI/CD pipelines now work without modifications
6. ⚠️ Interactive mode will be removed in v0.12.0

**Next Steps:**

1. Read updated [Getting Started Guide](getting-started.md)
2. Review [Authentication Guide](authentication.md) for new init workflows
3. Check [CI/CD examples](../examples/pipelines/) for updated patterns
4. Test migration in non-production environment first

## Related Documentation

- [Getting Started Guide](getting-started.md) - Complete setup with new commands
- [Authentication Guide](authentication.md) - Updated authentication workflows
- [Command Reference](command-reference.md) - Quick command syntax reference
- [Azure DevOps Integration](azure-devops-integration.md) - Updated pipeline templates
- [CHANGELOG](../CHANGELOG.md) - Full list of changes in v0.11.0

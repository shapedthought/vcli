services:
  azure-agent:
    build:
      context: .
      dockerfile: Dockerfile
      # Uncomment to force a specific platform (useful for testing)
      # platform: linux/amd64
      args:
        # Pin to a specific agent version for consistency
        AGENT_VERSION: 4.268.0
    container_name: owlctl-azure-agent
    # Uncomment to force a specific platform at runtime
    # platform: linux/amd64
    environment:
      # Azure DevOps configuration
      - AZP_URL=${AZP_URL}
      - AZP_TOKEN=${AZP_TOKEN}
      - AZP_POOL=${AZP_POOL:-Default}
      - AZP_AGENT_NAME=${AZP_AGENT_NAME:-owlctl-docker-agent}

      # owlctl credentials for pipeline testing
      - OWLCTL_USERNAME=${OWLCTL_USERNAME}
      - OWLCTL_PASSWORD=${OWLCTL_PASSWORD}
      - OWLCTL_URL=${OWLCTL_URL}
    volumes:
      # Persistent workspace (so pipelines can write artifacts)
      - agent-work:/home/agent/work

      # Optional: Mount owlctl config if you want to test with existing profiles
      # - ~/.owlctl:/home/agent/.owlctl:ro

      # Optional: Mount local owlctl source for faster development iteration
      # Note: Pipelines should use 'git clone' for realistic testing
      # - ../../:/home/agent/local-owlctl:ro
    restart: unless-stopped
    networks:
      - owlctl-test

networks:
  owlctl-test:
    driver: bridge

volumes:
  agent-work:
    driver: local

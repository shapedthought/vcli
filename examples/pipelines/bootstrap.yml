# Bootstrap Pipeline
#
# Run-once pipeline that captures the current VBR environment into Git.
# This creates the foundation for GitOps workflows by exporting all jobs
# as YAML files and snapshotting all resource types into state.json.
#
# After running this pipeline, your repo will contain:
#   infrastructure/
#   └── jobs/
#       ├── backup-job-1.yaml
#       ├── kms-encrypted-backup.yaml
#       └── ...
#   state.json    ← contains state for ALL resource types
#
# Prerequisites:
#   - Variable Group 'veeam-credentials' with OWLCTL_USERNAME, OWLCTL_PASSWORD, OWLCTL_URL
#   - Self-hosted agent with Go installed (for building from source)
#   - Git repo with write permissions (persistCredentials enabled)
#
# Usage:
#   1. Copy this file to your repository
#   2. Create the pipeline in Azure DevOps
#   3. Run it once to bootstrap your GitOps state
#   4. Subsequent changes use retention-change-gitops.yml or similar pipelines

trigger: none  # Manual trigger only - run once to bootstrap

pool:
  name: 'Default'

variables:
  - group: 'veeam-credentials'

  # owlctl source (for self-hosted agent building from source)
  - name: owlctlRepo
    value: 'https://github.com/shapedthought/owlctl.git'
  - name: owlctlBranch
    value: 'master'

  # Ensure owlctl writes config and state into the repo checkout
  - name: OWLCTL_SETTINGS_PATH
    value: '$(Build.SourcesDirectory)'

stages:
  - stage: Bootstrap
    displayName: 'Bootstrap VBR State into Git'
    jobs:
      - job: CaptureAndCommit
        displayName: 'Export jobs, snapshot state, and commit'
        steps:
          - checkout: self
            persistCredentials: true

          - script: |
              echo "=========================================="
              echo "Building owlctl from source"
              echo "=========================================="
              git clone --branch $(owlctlBranch) --depth 1 $(owlctlRepo) $(Agent.TempDirectory)/owlctl-src
              cd $(Agent.TempDirectory)/owlctl-src
              go build -o $(Build.SourcesDirectory)/owlctl
              echo "Build successful"
            displayName: 'Build owlctl'

          - script: |
              cd $(Build.SourcesDirectory)

              echo "Initializing owlctl..."
              ./owlctl init --insecure

              echo "Logging in to VBR..."
              ./owlctl login
              if [ $? -ne 0 ]; then
                echo "##vso[task.logissue type=error]Failed to authenticate with VBR"
                exit 1
              fi
              echo "Authentication successful"
            displayName: 'Initialize and authenticate'
            env:
              OWLCTL_USERNAME: $(OWLCTL_USERNAME)
              OWLCTL_PASSWORD: $(OWLCTL_PASSWORD)
              OWLCTL_URL: $(OWLCTL_URL)

          - script: |
              cd $(Build.SourcesDirectory)

              echo "=========================================="
              echo "Exporting all jobs as YAML"
              echo "=========================================="
              mkdir -p infrastructure/jobs
              ./owlctl export --all -d infrastructure/jobs/
              if [ $? -ne 0 ]; then
                echo "##vso[task.logissue type=error]Failed to export jobs"
                exit 1
              fi

              echo ""
              echo "Exported jobs:"
              ls -la infrastructure/jobs/
            displayName: 'Export all jobs'
            env:
              OWLCTL_USERNAME: $(OWLCTL_USERNAME)
              OWLCTL_PASSWORD: $(OWLCTL_PASSWORD)
              OWLCTL_URL: $(OWLCTL_URL)

          - script: |
              cd $(Build.SourcesDirectory)

              echo "=========================================="
              echo "Snapshotting all resource types"
              echo "=========================================="
              set +e  # Continue on individual failures

              echo ""
              echo "--- Snapshotting repositories ---"
              ./owlctl repo snapshot --all
              REPO_EXIT=$?

              echo ""
              echo "--- Snapshotting scale-out repositories ---"
              ./owlctl repo sobr-snapshot --all
              SOBR_EXIT=$?

              echo ""
              echo "--- Snapshotting encryption passwords ---"
              ./owlctl encryption snapshot --all
              ENC_EXIT=$?

              echo ""
              echo "--- Snapshotting KMS servers ---"
              ./owlctl encryption kms-snapshot --all
              KMS_EXIT=$?

              set -e

              echo ""
              echo "=========================================="
              echo "Snapshot Summary"
              echo "=========================================="
              echo "  Repositories:    exit $REPO_EXIT"
              echo "  SOBRs:           exit $SOBR_EXIT"
              echo "  Encryption:      exit $ENC_EXIT"
              echo "  KMS Servers:     exit $KMS_EXIT"

              if [ ! -f state.json ]; then
                echo ""
                echo "##vso[task.logissue type=warning]state.json was not created - VBR may have no resources to snapshot"
              else
                echo ""
                echo "State file created:"
                ls -la state.json
              fi
            displayName: 'Snapshot all resources'
            env:
              OWLCTL_USERNAME: $(OWLCTL_USERNAME)
              OWLCTL_PASSWORD: $(OWLCTL_PASSWORD)
              OWLCTL_URL: $(OWLCTL_URL)

          - script: |
              cd $(Build.SourcesDirectory)

              echo "=========================================="
              echo "Committing bootstrap state to Git"
              echo "=========================================="

              git config user.email "owlctl-pipeline@azure-devops.local"
              git config user.name "owlctl Bootstrap Pipeline"

              # Stage infrastructure specs and state
              git add infrastructure/
              git add state.json 2>/dev/null || true

              # Verify there are changes to commit
              if git diff --cached --quiet; then
                echo "No changes to commit - repository may already be bootstrapped"
                exit 0
              fi

              echo ""
              echo "Files to commit:"
              git diff --cached --name-only

              git commit -m "Bootstrap VBR declarative management [skip ci]

              Exported all backup jobs as YAML specs.
              Snapshotted repositories, SOBRs, encryption, and KMS state."

              git push origin HEAD:refs/heads/$(Build.SourceBranchName)
              if [ $? -ne 0 ]; then
                echo "##vso[task.logissue type=error]Failed to push bootstrap commit"
                exit 1
              fi

              echo ""
              echo "=========================================="
              echo "Bootstrap Complete"
              echo "=========================================="
              echo ""
              echo "Your repository now contains:"
              echo "  infrastructure/jobs/  - Backup job YAML specs"
              echo "  state.json            - Baseline state for drift detection"
              echo ""
              echo "Next steps:"
              echo "  1. Review the committed files"
              echo "  2. Use retention-change-gitops.yml to make changes"
              echo "  3. Use detect-remediate.yml for ongoing drift monitoring"
            displayName: 'Commit and push'

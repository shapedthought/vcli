# Test pipeline for local Azure DevOps agent
# This pipeline verifies the agent is working and tests basic owlctl functionality

trigger: none

# Manual trigger only - click "Run pipeline" to test
pr: none

pool:
  name: 'Default'  # Change to match your AZP_POOL value
  # No architecture demand - works on both ARM64 (Apple Silicon) and X64 (Intel)

variables:
  # owlctl repository to test with
  - name: owlctlRepo
    value: 'https://github.com/shapedthought/owlctl.git'
  - name: owlctlBranch
    value: 'master'

stages:
  - stage: Verify
    displayName: 'Verify Agent Environment'
    jobs:
      - job: CheckEnv
        displayName: 'Check environment'
        workspace:
          clean: all  # Clean workspace before each run
        steps:
          - checkout: none  # Don't automatically checkout

          - script: |
              echo "=========================================="
              echo "Agent Information"
              echo "=========================================="
              echo "Agent Name: $(Agent.Name)"
              echo "Agent OS: $(Agent.OS)"
              echo "Agent Architecture: $(Agent.OSArchitecture)"
              echo "Working Directory: $(Agent.WorkFolder)"
              echo "Build Directory: $(Build.SourcesDirectory)"
              echo ""
              echo "=========================================="
              echo "Installed Tools"
              echo "=========================================="
              echo "Go version:"
              go version
              echo ""
              echo "Git version:"
              git --version
              echo ""
              echo "JQ version:"
              jq --version
              echo "=========================================="
            displayName: 'Show environment info'

  - stage: Build
    displayName: 'Build owlctl'
    dependsOn: Verify
    jobs:
      - job: BuildVcli
        displayName: 'Build owlctl from source'
        workspace:
          clean: all
        steps:
          - checkout: none

          - script: |
              echo "Cloning owlctl repository..."
              git clone --branch $(owlctlBranch) --depth 1 $(owlctlRepo) $(Build.SourcesDirectory)/owlctl
              cd $(Build.SourcesDirectory)/owlctl
              echo ""
              echo "Repository info:"
              git log -1 --oneline
              echo ""
              echo "Building owlctl..."
              go build -o owlctl
              echo ""
              echo "Build successful!"
              ./owlctl --version || echo "owlctl version command not available"
              ls -lh owlctl
            displayName: 'Clone and build owlctl'

  - stage: TestImperative
    displayName: 'Test Imperative Mode'
    dependsOn: Build
    jobs:
      - job: TestCommands
        displayName: 'Test owlctl commands'
        workspace:
          clean: all
        steps:
          - checkout: none

          - script: |
              git clone --branch $(owlctlBranch) --depth 1 $(owlctlRepo) $(Build.SourcesDirectory)/owlctl
              cd $(Build.SourcesDirectory)/owlctl
              go build -o owlctl

              # Initialize owlctl (creates config files in current directory)
              echo "Initializing owlctl..."
              ./owlctl init --insecure

              echo ""
              echo "Available profiles:"
              ./owlctl profile --list
            displayName: 'Clone, build, and initialize owlctl'

          - script: |
              cd $(Build.SourcesDirectory)/owlctl
              echo "Setting VBR profile..."
              ./owlctl profile --set vbr

              echo ""
              echo "Attempting login to VBR..."
              ./owlctl login

              if [ $? -eq 0 ]; then
                echo "Login successful"
              else
                echo "Login failed"
                echo "Check OWLCTL_USERNAME, OWLCTL_PASSWORD, and OWLCTL_URL in pipeline variables"
                exit 1
              fi
            displayName: 'Test VBR login'
            env:
              OWLCTL_USERNAME: $(OWLCTL_USERNAME)
              OWLCTL_PASSWORD: $(OWLCTL_PASSWORD)
              OWLCTL_URL: $(OWLCTL_URL)
            continueOnError: true  # Don't fail if VBR is not reachable

  - stage: TestDeclarative
    displayName: 'Test Declarative Mode'
    dependsOn: TestImperative
    condition: succeeded()  # Only run if login succeeded
    jobs:
      - job: TestDrift
        displayName: 'Test drift detection'
        workspace:
          clean: all
        steps:
          - checkout: none

          - script: |
              git clone --branch $(owlctlBranch) --depth 1 $(owlctlRepo) $(Build.SourcesDirectory)/owlctl
              cd $(Build.SourcesDirectory)/owlctl
              go build -o owlctl

              # Initialize and login
              echo "Initializing owlctl..."
              ./owlctl init --insecure
              ./owlctl profile --set vbr

              echo "Logging in to VBR..."
              ./owlctl login
            displayName: 'Clone, build, and setup owlctl'
            env:
              OWLCTL_USERNAME: $(OWLCTL_USERNAME)
              OWLCTL_PASSWORD: $(OWLCTL_PASSWORD)
              OWLCTL_URL: $(OWLCTL_URL)

          - script: |
              cd $(Build.SourcesDirectory)/owlctl

              echo "=========================================="
              echo "Snapshotting Current State as Baseline"
              echo "=========================================="

              echo "Snapshotting all jobs..."
              ./owlctl job snapshot --all || true

              echo ""
              echo "Snapshotting repositories..."
              ./owlctl repo snapshot --all || true

              echo ""
              echo "Snapshotting scale-out repositories..."
              ./owlctl repo sobr-snapshot --all || true

              echo ""
              echo "Snapshotting encryption passwords..."
              ./owlctl encryption snapshot --all || true

              echo ""
              echo "Snapshotting KMS servers..."
              ./owlctl encryption kms-snapshot --all || true

              echo ""
              echo "State file created:"
              ls -lh state.json 2>/dev/null || echo "No state file found"
            displayName: 'Snapshot current VBR state as baseline'
            env:
              OWLCTL_PASSWORD: $(OWLCTL_PASSWORD)

          - script: |
              cd $(Build.SourcesDirectory)/owlctl

              echo "=========================================="
              echo "Testing Job Drift Detection"
              echo "=========================================="

              ./owlctl job diff --all
              JOB_EXIT=$?

              echo ""
              echo "Job diff exit code: $JOB_EXIT"

              case $JOB_EXIT in
                0)
                  echo "No drift detected"
                  ;;
                3)
                  echo "Warning-level drift detected"
                  echo "##vso[task.logissue type=warning]Non-critical job drift detected"
                  ;;
                4)
                  echo "CRITICAL drift detected"
                  echo "##vso[task.logissue type=error]CRITICAL job drift detected"
                  ;;
                *)
                  echo "Error occurred (exit code: $JOB_EXIT)"
                  ;;
              esac
            displayName: 'Test job diff'
            env:
              OWLCTL_PASSWORD: $(OWLCTL_PASSWORD)
            continueOnError: true

          - script: |
              cd $(Build.SourcesDirectory)/owlctl

              echo "=========================================="
              echo "Testing Repository Drift Detection"
              echo "=========================================="

              ./owlctl repo diff --all
              REPO_EXIT=$?

              echo ""
              echo "Repository diff exit code: $REPO_EXIT"
            displayName: 'Test repo diff'
            env:
              OWLCTL_PASSWORD: $(OWLCTL_PASSWORD)
            continueOnError: true

          - script: |
              cd $(Build.SourcesDirectory)/owlctl

              echo "=========================================="
              echo "Testing Security-Only Filtering"
              echo "=========================================="

              ./owlctl job diff --all --security-only
              EXIT_CODE=$?

              if [ $EXIT_CODE -eq 4 ]; then
                echo "##vso[task.logissue type=error]CRITICAL security drift detected"
                echo "##vso[build.addbuildtag]critical-drift"
                echo "This would fail a CI/CD pipeline"
              elif [ $EXIT_CODE -eq 3 ]; then
                echo "##vso[task.logissue type=warning]Security drift detected (non-critical)"
                echo "##vso[task.complete result=SucceededWithIssues;]Drift detected"
              else
                echo "No security drift detected"
              fi
            displayName: 'Test security drift filtering'
            env:
              OWLCTL_PASSWORD: $(OWLCTL_PASSWORD)
            continueOnError: true

  - stage: Summary
    displayName: 'Test Summary'
    dependsOn:
      - Verify
      - Build
      - TestImperative
      - TestDeclarative
    condition: always()
    jobs:
      - job: ShowResults
        displayName: 'Show test results'
        steps:
          - script: |
              echo "=========================================="
              echo "Test Pipeline Summary"
              echo "=========================================="
              echo "Pipeline: $(Build.DefinitionName)"
              echo "Build Number: $(Build.BuildNumber)"
              echo "Agent: $(Agent.Name)"
              echo ""
              echo "Agent verification: Complete"
              echo "owlctl build: Check previous stages"
              echo "Imperative mode tests: Check previous stages"
              echo "Declarative mode tests: Check previous stages"
              echo "=========================================="
              echo ""
              echo "Next steps:"
              echo "1. Check the 'Tests' tab for detailed results"
              echo "2. Review logs for any warnings or errors"
              echo "3. Try the example pipelines in examples/pipelines/"
              echo "=========================================="
            displayName: 'Summary'
